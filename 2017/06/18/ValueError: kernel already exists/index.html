<!-- build time:Sun Dec 15 2019 23:52:01 GMT+0800 (China Standard Time) --><!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>ValueError: Variable lstm_cell/rnn/multi_rnn_cell/cell_0/basic_lstm_cell/kernel already exists. | Yu Li</title><meta name="description" content="写在前面最近在学习使用tensorflow构建language model，遇到关于模型重用的问题，我将模型的训练和预测放在同一个文件中时出现的问题,提示lstm_cell kernal已经存在. 错误提示123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525"><meta name="keywords" content="Tensorflow,Deeplearning,ValueError"><meta property="og:type" content="article"><meta property="og:title" content="ValueError: Variable lstm_cell&#x2F;rnn&#x2F;multi_rnn_cell&#x2F;cell_0&#x2F;basic_lstm_cell&#x2F;kernel already exists."><meta property="og:url" content="http://sthsf.github.io/2017/06/18/ValueError: kernel already exists/index.html"><meta property="og:site_name" content="Yu Li&#39;s personal blog"><meta property="og:description" content="写在前面最近在学习使用tensorflow构建language model，遇到关于模型重用的问题，我将模型的训练和预测放在同一个文件中时出现的问题,提示lstm_cell kernal已经存在. 错误提示123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2017-08-31T05:40:31.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ValueError: Variable lstm_cell&#x2F;rnn&#x2F;multi_rnn_cell&#x2F;cell_0&#x2F;basic_lstm_cell&#x2F;kernel already exists."><meta name="twitter:description" content="写在前面最近在学习使用tensorflow构建language model，遇到关于模型重用的问题，我将模型的训练和预测放在同一个文件中时出现的问题,提示lstm_cell kernal已经存在. 错误提示123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525"><link rel="canonical" href="http://sthsf.github.io/2017/06/18/ValueError: kernel already exists/index.html"><link rel="icon" href="/favicon.png" type="image/x-icon"><link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"></head></html><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/sthsf" target="_blank"><img class="thumb-xl img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Yu Li</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Algorithm Developer &amp; Designer</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="fa fa-map-marker"></i> ShangHai, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="Search"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat"><i class="fa fa-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-about"><a href="/about"><i class="fa fa-fw fa-coffee"></i> <span class="menu-title">About</span></a></li><li class="menu-item menu-item-home"><a href="/."><i class="fa fa-fw fa-dashboard"></i> <span class="menu-title">Home</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="fa fa-fw fa-delicious"></i> <span class="menu-title">Archives</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="fa fa-fw fa-folder"></i> <span class="menu-title">Categories</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="fa fa-fw fa-tags"></i> <span class="menu-title">Tags</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="fa fa-fw fa-code"></i> <span class="menu-title">Repository</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="fa fa-fw fa-gg"></i> <span class="menu-title">Links</span></a></li><li class="menu-item menu-item-books"><a href="/books"><i class="fa fa-fw fa-leanpub"></i> <span class="menu-title">Books</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/sthsf" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="fa fa-github"></i></a></li><li><a href="http://weibo.com/sthsf" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="fa fa-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="fa fa-twitter"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="fa fa-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">Tags</h3><div class="widget-body"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/">Blog</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Deeplearning/">Deeplearning</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/">Tensorflow</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow基础知识/">Tensorflow基础知识</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ValueError/">ValueError</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/智能问答系统/">智能问答系统</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/概率论/">概率论</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/知识图谱/">知识图谱</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/统计学习/">统计学习</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/综述/">综述</a><span class="tag-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Categories</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tensorflow/">Tensorflow</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tensorflow基础知识/">Tensorflow基础知识</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python基础知识/">python基础知识</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/智能问答系统/">智能问答系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/知识图谱/">知识图谱</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/统计学习/">统计学习</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Archive</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Recent Posts</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/python基础知识/">python基础知识</a></p><p class="item-title"><a href="/2019/08/24/python基础知识--协程/" class="title">python与协程</a></p><p class="item-date"><time datetime="2019-08-24T02:09:46.000Z" itemprop="datePublished">2019-08-24</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/智能问答系统/">智能问答系统</a></p><p class="item-title"><a href="/2019/03/16/智能问答系统的探索和实践/" class="title">智能问答系统的探索和实践</a></p><p class="item-date"><time datetime="2019-03-16T02:09:46.000Z" itemprop="datePublished">2019-03-16</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/知识图谱/">知识图谱</a></p><p class="item-title"><a href="/2019/03/15/知识图谱的基础知识和应用场景/" class="title">知识图谱的基础知识和应用场景</a></p><p class="item-date"><time datetime="2019-03-15T02:09:46.000Z" itemprop="datePublished">2019-03-15</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Tensorflow基础知识/">Tensorflow基础知识</a></p><p class="item-title"><a href="/2017/09/14/Tensorflow中的共享变量机制/" class="title">Tensorflow中的共享变量机制</a></p><p class="item-date"><time datetime="2017-09-14T02:14:56.000Z" itemprop="datePublished">2017-09-14</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Tensorflow基础知识/">Tensorflow基础知识</a></p><p class="item-title"><a href="/2017/09/04/Tensorflow中dynamic-rnn和row-rnn的区别/" class="title">Tensorflow中dynamic_rnn和row_rnn的区别</a></p><p class="item-date"><time datetime="2017-09-04T00:58:38.000Z" itemprop="datePublished">2017-09-04</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-ValueError: kernel already exists" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">ValueError: Variable lstm_cell/rnn/multi_rnn_cell/cell_0/basic_lstm_cell/kernel already exists.</h1><div class="article-meta"><span class="article-date"><i class="fa fa-calendar-check-o"></i> <a href="/2017/06/18/ValueError: kernel already exists/" class="article-date"><time datetime="2017-06-18T02:00:00.000Z" itemprop="datePublished">2017-06-18</time></a></span> <span class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/Tensorflow/">Tensorflow</a></span> <span class="article-tag"><i class="fa fa-tag"></i> <a class="article-tag-link" href="/tags/Deeplearning/">Deeplearning</a>, <a class="article-tag-link" href="/tags/Tensorflow/">Tensorflow</a>, <a class="article-tag-link" href="/tags/ValueError/">ValueError</a></span> <span class="article-read hidden-xs"><i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_container_page_pv">阅读<span id="busuanzi_value_page_pv">0</span>次</span></span> <span class="post-comment"><i class="fa fa-commenting-o"></i> <a href="/2017/06/18/ValueError: kernel already exists/#comments" class="article-comment-link">Comments</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 1,538(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 8(分)</span></div></div><div class="article-entry markdown-body" itemprop="articleBody"><h1 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h1><p>最近在学习使用tensorflow构建language model，遇到关于模型重用的问题，我将模型的训练和预测放在同一个文件中时出现的问题,提示lstm_cell kernal已经存在.</p><h1 id="错误提示"><a class="markdownIt-Anchor" href="#错误提示"></a> 错误提示</h1><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">48 Traceback (most recent call last): </span><br><span class="line">49 <span class="keyword">File</span> <span class="string">"anna_writer.py"</span>, <span class="keyword">line</span> 274, <span class="keyword">in</span> &lt;module&gt; </span><br><span class="line">50 samp = generate_samples(checkpoint, 20000, prime=<span class="string">"The "</span>) </span><br><span class="line">51 <span class="keyword">File</span> <span class="string">"anna_writer.py"</span>, <span class="keyword">line</span> 234, <span class="keyword">in</span> generate_samples </span><br><span class="line">52 <span class="keyword">conf</span>.lstm_size, <span class="keyword">conf</span>.keep_prob, <span class="keyword">conf</span>.grad_clip, False) </span><br><span class="line">53 <span class="keyword">File</span> <span class="string">"anna_writer.py"</span>, <span class="keyword">line</span> 74, <span class="keyword">in</span> __init__ </span><br><span class="line">54 self.add_lstm_cell() </span><br><span class="line">55 <span class="keyword">File</span> <span class="string">"anna_writer.py"</span>, <span class="keyword">line</span> 110, <span class="keyword">in</span> add_lstm_cell </span><br><span class="line">56 initial_state=self.initial_state) </span><br><span class="line">57 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py"</span>, <span class="keyword">line</span> 574, ii <span class="keyword">n</span> dynamic_rnn </span><br><span class="line">58 dtype=dtype) </span><br><span class="line">59 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py"</span>, <span class="keyword">line</span> 737, ii <span class="keyword">n</span> _dynamic_rnn_loop </span><br><span class="line">60 swap_memory=swap_memory) </span><br><span class="line">61 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py"</span>" , <span class="keyword">line</span> 2770, <span class="keyword">in</span> while_loop </span><br><span class="line">62 result = context.BuildLoop(cond, body, loop_vars, shape_invariants) </span><br><span class="line">63 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py"</span>" , <span class="keyword">line</span> 2599, <span class="keyword">in</span> BuildLoop </span><br><span class="line">64 pred, body, original_loop_vars, loop_vars, shape_invariants) </span><br><span class="line">65 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/control_flow_ops.py"</span>" , <span class="keyword">line</span> 2549, <span class="keyword">in</span> _BuildLoop </span><br><span class="line">66 body_result = body(*packed_vars_for_body) </span><br><span class="line">67 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py"</span>, <span class="keyword">line</span> 722, ii <span class="keyword">n</span> _time_step </span><br><span class="line">68 (output, new_state) = call_cell() </span><br><span class="line">69 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn.py"</span>, <span class="keyword">line</span> 708, ii <span class="keyword">n</span> &lt;lambda&gt; </span><br><span class="line">70 call_cell = lambda: cell(input_t, state) </span><br><span class="line">71 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, ll ine 180, <span class="keyword">in</span> __call__ </span><br><span class="line">72 <span class="keyword">return</span> super(RNNCell, self).__call__(inputs, state) </span><br><span class="line">73 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/layers/base.py"</span>, <span class="keyword">line</span> 444 1, <span class="keyword">in</span> __call__ </span><br><span class="line">74 outputs = self.call(inputs, *<span class="keyword">args</span>, **kwargs) </span><br><span class="line">75 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, <span class="keyword">l</span> ine 916, <span class="keyword">in</span> call </span><br><span class="line">76 cur_inp, new_state = cell(cur_inp, cur_state) </span><br><span class="line">77 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, <span class="keyword">l</span> ine 752, <span class="keyword">in</span> __call__ </span><br><span class="line">78 output, new_state = self._cell(inputs, state, scope) </span><br><span class="line">79 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, <span class="keyword">l</span> ine 180, <span class="keyword">in</span> __call__ </span><br><span class="line">80 <span class="keyword">return</span> super(RNNCell, self).__call__(inputs, state) </span><br><span class="line">81 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/layers/base.py"</span>, <span class="keyword">line</span> 44 1, <span class="keyword">in</span> __call__ </span><br><span class="line">82 outputs = self.call(inputs, *<span class="keyword">args</span>, **kwargs) </span><br><span class="line">83 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, <span class="keyword">l</span> ine 383, <span class="keyword">in</span> call </span><br><span class="line">84 concat = _linear([inputs, <span class="keyword">h</span>], 4 * self._num_units, True) </span><br><span class="line">85 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, <span class="keyword">l</span> ine 1017, <span class="keyword">in</span> _linear </span><br><span class="line">86 initializer=kernel_initializer) </span><br><span class="line">87 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/variable_scope.py"</span>, <span class="keyword">line</span> 1065, <span class="keyword">in</span> get_variable </span><br><span class="line">88 use_resource=use_resource, custom_getter=custom_getter) </span><br><span class="line">89 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/variable_scope.py"</span>, <span class="keyword">line</span> 962, <span class="keyword">in</span> get_variable </span><br><span class="line">90 use_resource=use_resource, custom_getter=custom_getter) </span><br><span class="line">91 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/variable_scope.py"</span>, <span class="keyword">line</span> 360, <span class="keyword">in</span> get_variable </span><br><span class="line">92 validate_shape=validate_shape, use_resource=use_resource) </span><br><span class="line">93 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/variable_scope.py"</span>, <span class="keyword">line</span> 1405, <span class="keyword">in</span> wrapped_custom_getter </span><br><span class="line">94 *<span class="keyword">args</span>, **kwargs) </span><br><span class="line">95 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, <span class="keyword">l</span> ine 183, <span class="keyword">in</span> _rnn_get_variable </span><br><span class="line">96 variable = getter(*<span class="keyword">args</span>, **kwargs) </span><br><span class="line">97 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/rnn_cell_impl.py"</span>, <span class="keyword">l</span> ine 183, <span class="keyword">in</span> _rnn_get_variable </span><br><span class="line">98 variable = getter(*<span class="keyword">args</span>, **kwargs) </span><br><span class="line">99 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/variable_scope.py"</span>, <span class="keyword">line</span> 352, <span class="keyword">in</span> _true_getter </span><br><span class="line">100 use_resource=use_resource) </span><br><span class="line">101 <span class="keyword">File</span> <span class="string">"/home/tf1.0/local/lib/python2.7/site-packages/tensorflow/python/ops/variable_scope.py"</span>, <span class="keyword">line</span> 664, <span class="keyword">in</span> _get_single_variable </span><br><span class="line">102 name, <span class="string">""</span>.join(traceback.format_list(tb)))) </span><br><span class="line">103 ValueError: Variable lstm_cell/rnn/multi_rnn_cell/cell_0/basic_lstm_cell/kernel already exists, disallowed. Did you <span class="keyword">mean</span> to <span class="keyword">set</span> reuse=True <span class="keyword">in</span> VarScope? Originally defined at:</span><br><span class="line">104 105 <span class="keyword">File</span> <span class="string">"anna_writer.py"</span>, <span class="keyword">line</span> 110, <span class="keyword">in</span> add_lstm_cell </span><br><span class="line">106 initial_state=self.initial_state) </span><br><span class="line">107 <span class="keyword">File</span> <span class="string">"anna_writer.py"</span>, <span class="keyword">line</span> 74, <span class="keyword">in</span> __init__ </span><br><span class="line">108 self.add_lstm_cell() </span><br><span class="line">109 <span class="keyword">File</span> <span class="string">"anna_writer.py"</span>, <span class="keyword">line</span> 172, <span class="keyword">in</span> train 110 <span class="keyword">conf</span>.grad_clip, is_training=True)</span><br></pre></td></tr></table></figure><h1 id="解决方法"><a class="markdownIt-Anchor" href="#解决方法"></a> 解决方法</h1><p>这个问题困扰了我两天，始终找不到解决方案，当我的训练模型和预测模型分开运行时程序没有报错，但是两个程序放在一起运行时就会出现问题，网上搜索的结果大都是关于<a href="https://stackoverflow.com/questions/43957967/tensorflow-v1-1-0-multi-rnn-basiclstmcell-error-reuse-parameter-python-3-5" target="_blank" rel="noopener">共享权重的问题</a>，错误提示是:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValueError: Variable hello/rnn/basic_lstm_cell/weights already exists, disallowed. Did you mean <span class="keyword">to</span> <span class="builtin-name">set</span> <span class="attribute">reuse</span>=<span class="literal">True</span> <span class="keyword">in</span> VarScope?</span><br></pre></td></tr></table></figure><p>这个error跟我的错误还是有一定的区别的。这些问题主要原因在于使用多层lstm_cell或者双向lstm的时候忽略了定义变量的variable_scope，导致lstm_cell的作用域不一样，但是程序加载的时候并不知道，所以当声明的cell不是同一个的时候，需要用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">with tf.variable_scope(name):</span><br></pre></td></tr></table></figure><p>来定义不同的作用范围就可以了，具体还要根据实际情况。</p><p>而我的问题好像网上还没有这样的解释，我仔细看错误的提示，分析我的代码，当train和predict放在一起的时候，会调用两次class language_model：这时候就会出现系统里应该存在两个不同的lstm_cell模型，但是系统无法辨别出来，所以会提示<strong>kernel already exists</strong>，而不是<strong>weights already exists</strong>。</p><p>而tensorflow有一个reset_default_graph()函数，我对python多线程不是很清楚，贴下源码，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_default_graph</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="string">"""Clears the default graph stack and resets the global default graph.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  NOTE: The default graph is a property of the current thread. This</span></span><br><span class="line"><span class="string">  function applies only to the current thread.  Calling this function while</span></span><br><span class="line"><span class="string">  a `tf.Session` or `tf.InteractiveSession` is active will result in undefined</span></span><br><span class="line"><span class="string">  behavior. Using any previously created `tf.Operation` or `tf.Tensor` objects</span></span><br><span class="line"><span class="string">  after calling this function will result in undefined behavior.</span></span><br><span class="line"><span class="string">  """</span></span><br></pre></td></tr></table></figure><p>然后在我定义的language_model类中添加这个函数之后之前的问题就解决了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">language_model</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num_classes, batch_size=<span class="number">100</span>, seq_length=<span class="number">50</span>, learning_rate=<span class="number">0.01</span>, num_layers=<span class="number">5</span>, hidden_units=<span class="number">128</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 keep_prob=<span class="number">0.8</span>, grad_clip=<span class="number">5</span>, is_training=True)</span>:</span></span><br><span class="line">        <span class="comment"># 模型的训练和预测放在同一个文件下时如果没有这个函数会报错。</span></span><br><span class="line">        tf.reset_default_graph()  </span><br><span class="line">        self.learning_rate = learning_rate</span><br><span class="line">        self.num_layers = num_layers</span><br><span class="line">        self.hidden_units = hidden_units</span><br><span class="line">        self.is_training = is_training</span><br><span class="line">        self.keep_prob = keep_prob</span><br><span class="line">        self.grad_clip = grad_clip</span><br><span class="line">        self.num_classes = num_classes</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.is_training:</span><br><span class="line">            self.batch_size = batch_size</span><br><span class="line">            self.seq_length = seq_length</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.batch_size = <span class="number">1</span></span><br><span class="line">            self.seq_length = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">'add_input_layer'</span>):</span><br><span class="line">            self.add_input_layer()</span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'lstm_cell'</span>):</span><br><span class="line">            self.add_multi_cells()</span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">'build_output'</span>):</span><br><span class="line">            self.build_output()</span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">'cost'</span>):</span><br><span class="line">            self.compute_cost()</span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">'train_op'</span>):</span><br><span class="line">            self.train_op()</span><br></pre></td></tr></table></figure><p><strong>题外话</strong> ：tensorflow1.2版本之后，定义多层lstm(<code>MultiRNNCell</code>)与原来的版本改变比较大，可以看考<a href="https://www.tensorflow.org/tutorials/recurrent#recurrent-neural-networks" target="_blank" rel="noopener">PTB tutorials—Stacking multiple LSTMs</a>.</p><p><em><strong>文中涉及到的代码见：<a href="https://github.com/STHSF/DeepNaturalLanguageProcessing/tree/master/language_model/anna" target="_blank" rel="noopener">github–anna</a></strong></em></p><h1 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h1><p><a href="http://blog.csdn.net/u014283248/article/details/64440268" target="_blank" rel="noopener">1、tensorflow1.x版本rnn生成cell 报错解决方案</a></p><p><a href="http://www.cnblogs.com/max-hu/p/7101164.html" target="_blank" rel="noopener">2、ValueError: Attempt to reuse RNNCell</a></p><p><a href="https://stackoverflow.com/questions/43935609/how-to-reuse-weights-in-multirnncell" target="_blank" rel="noopener">3、How to reuse weights in MultiRNNCell?</a></p><p><a href="https://github.com/tensorflow/tensorflow/issues/8191" target="_blank" rel="noopener">4、ValueError: Attempt to reuse RNNCell with a different variable scope than its first use.</a></p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://sthsf.github.io/2017/06/18/ValueError: kernel already exists/" title="ValueError: Variable lstm_cell/rnn/multi_rnn_cell/cell_0/basic_lstm_cell/kernel already exists." target="_blank" rel="external">http://sthsf.github.io/2017/06/18/ValueError: kernel already exists/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/sthsf" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/sthsf" target="_blank"><span class="text-dark">Yu Li</span><small class="ml-1x">Algorithm Developer &amp; Designer</small></a></h3><div></div></div></figure></div></div></div></article><section id="comments"><div id="uyan_frame"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2017/08/24/极大似然估计学习总结/" title="极大似然估计学习总结"><i class="fa fa-angle-left" aria-hidden="true"></i>&nbsp;&nbsp;Newer</a></li><li class="next"><a href="/2017/03/18/Errors when buildding blog with hexo/" title="Errors when buildding blog with hexo">Older&nbsp;&nbsp;<i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning hidden-xs" data-toggle="modal" data-target="#donateModal"><span>$</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter, baidu" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-tit"><p>Thank you for your support, I will continue to work hard!</p></div><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="Scan Qrcode" title="Scan"></div><p class="text-muted mv">Scan this qrcode</p><div class="donate-payselect"><div class="pay_item checked" data-id="alipay" data-src="/images/donate/alipayimg.png"><div class="radio"><input type="radio" name="payment" id="input-alipay" value="alipay" checked><label class="pay_logo clickable" for="input-alipay"><img src="/images/donate/alipay.jpg" alt="alipay"></label></div></div><div class="pay_item" data-id="weipay" data-src="/images/donate/weipayimg.png"><div class="radio"><input type="radio" name="payment" id="input-weipay" value="weipay"><label class="pay_logo clickable" for="input-weipay"><img src="/images/donate/weipay.jpg" alt="weipay"></label></div></div></div><div class="text-grey"><p>Open<span id="donate-pay_txt">alipay</span>Scan this qrcode, you can sweep yards reward oh!</p></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/sthsf" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="fa fa-github"></i></a></li><li><a href="http://weibo.com/sthsf" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="fa fa-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="fa fa-twitter"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="fa fa-rss"></i></a></li></ul><div class="copyright">&copy; 2019 Yu Li<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.js"></script><script src="/js/application.js"></script><script>!function(T){var n={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=n}(window)</script><script src="/js/insight.js"></script><script defer src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=[object Object]"></script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?f4564a0992521543e48ba54ba9be25a5";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body><!-- rebuild by neat -->